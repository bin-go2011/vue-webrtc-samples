<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recording</title>
    <script src="https://unpkg.com/vue@next"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        const { defineComponent, createApp } = Vue;

        let mediaRecorder;
        let recordedBlobs;
        let audioPlayer;

        const component = defineComponent({
            data() {
                return {
                    status: "start"
                }
            },

            methods: {
                async startClickHandler() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                        console.log('获得音频stream: ', stream);
                        window.stream = stream;
                        this.status = "startRecord";
                    } catch (error) {
                        console.log('navigator.mediaDevices.getUserMedia error: ', error);
                    }
                },
                startRecordButtonClickHandler() {
                    recordedBlobs = [];
                    let options = { mimeType: "audio/webm; codecs=opus"};
                    try {
                        mediaRecorder = new MediaRecorder(window.stream, options);
                    } catch (error) {
                        console.log('MediaRecorder创建失败:', error);
                        return;
                    }

                    mediaRecorder.onstop = (event) => {
                        console.log('Recorder stopped: ', event);
                        console.log('Recorded Blobs: ', recordedBlobs);
                    }

                    mediaRecorder.ondataavailable = this.handleDataAvailable;
                    mediaRecorder.start(10);
                    console.log('MediaRecorder started', mediaRecorder);
                    this.status = 'stopRecord';
                },
                stopRecordButtonClickHandler() {
                    mediaRecorder.stop();
                    this.status = 'play';
                },
                playButtonClickHandler() {
                    const blob = new Blob(recordedBlobs, { type: 'audio/ogg' });
                    audioPlayer.src = null;
                    audioPlayer.src = window.URL.createObjectURL(blob);
                    audioPlayer.play();
                    this.status = "download";
                },
                downloadButtonClickHandler(e) {
                    const blob = new Blob(recordedBlobs, { type:'audio/ogg' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none'
                    a.href = url;
                    a.download = 'test.ogg';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(()=>{
                        document.body.removeChild(a);
                    }, 100);

                    this.status = 'start';
                },    
                handleDataAvailable(event) {
                    console.log('handleDataAvailable', event);
                    if (event.data && event.data.size > 0) {
                        recordedBlobs.push(event.data);
                    }
                }
            },

            mounted() {
                audioPlayer = this.$refs.audioPlayer;    
            },

            template: `
                <div>
                    <h1>
                        <span>音频录制</span>
                    </h1>
                    <audio ref="audioPlayer" controls autoplay></audio>
                    <div>
                        <button @click="startClickHandler" :disabled="status!='start'">打开麦克风</button>
                        <button @click="startRecordButtonClickHandler" :disabled="status!='startRecord'">开始录制</button>
                        <button @click="stopRecordButtonClickHandler" :disabled="status!='stopRecord'">停止录制</button>
                        <button @click="playButtonClickHandler" :disabled="status!='play'">播放</button>
                        <button @click="downloadButtonClickHandler" :disabled="status!='download'">下载</button>
                    </div>
                </div>

            `
        });

        createApp(component).mount('#app');
    </script>
</body>
</html>